From 597d4ffdc768d80d299f08e4bf5941017d15367f Mon Sep 17 00:00:00 2001
From: Daniel Green <venix1@gmail.com>
Date: Fri, 21 Jun 2013 17:27:36 -0500
Subject: [PATCH] MinGW TLS Support

---
 libphobos/libdruntime/Makefile.am                 |   3 +-
 libphobos/libdruntime/Makefile.in                 |   3 +-
 libphobos/libdruntime/core/sys/windows/dll.d      |  12 +-
 libphobos/libdruntime/core/sys/windows/mingwasm.S |  35 +++++
 libphobos/libdruntime/core/thread.d               | 148 +++++++++++++++++++++-
 5 files changed, 194 insertions(+), 7 deletions(-)
 create mode 100644 libphobos/libdruntime/core/sys/windows/mingwasm.S

diff --git a/libphobos/libdruntime/Makefile.am b/libphobos/libdruntime/Makefile.am
index b34dbb7..928feb7 100644
--- a/libphobos/libdruntime/Makefile.am
+++ b/libphobos/libdruntime/Makefile.am
@@ -129,7 +129,8 @@ RT_POSIX_OBJS=core/sys/posix/dirent.o core/sys/posix/netdb.o \
 
 RT_WINDOWS_OBJS=core/sys/windows/dbghelp.o core/sys/windows/dll.o \
 		core/sys/windows/stacktrace.o core/sys/windows/threadaux.o \
-		core/sys/windows/windows.o core/sys/windows/mingwex.o
+		core/sys/windows/windows.o core/sys/windows/mingwex.o \
+		core/sys/windows/mingwasm.o
 
 D_GC_MODULES=@D_GC_MODULES@
 
diff --git a/libphobos/libdruntime/Makefile.in b/libphobos/libdruntime/Makefile.in
index 74ea001..04d11e4 100644
--- a/libphobos/libdruntime/Makefile.in
+++ b/libphobos/libdruntime/Makefile.in
@@ -276,7 +276,8 @@ RT_POSIX_OBJS = core/sys/posix/dirent.o core/sys/posix/netdb.o \
 
 RT_WINDOWS_OBJS = core/sys/windows/dbghelp.o core/sys/windows/dll.o \
 		core/sys/windows/stacktrace.o core/sys/windows/threadaux.o \
-		core/sys/windows/windows.o core/sys/windows/mingwex.o
+		core/sys/windows/windows.o core/sys/windows/mingwex.o \
+		core/sys/windows/mingwasm.o
 
 
 # Regardless of OS, all import headers are generated.
diff --git a/libphobos/libdruntime/core/sys/windows/dll.d b/libphobos/libdruntime/core/sys/windows/dll.d
index 1a6e2bf..b608bb4 100644
--- a/libphobos/libdruntime/core/sys/windows/dll.d
+++ b/libphobos/libdruntime/core/sys/windows/dll.d
@@ -24,7 +24,17 @@ version( Windows )
 
     extern (C)
     {
-        version (Win32)
+		version (MinGW)
+		{
+			extern __gshared void* _tls_start;
+			extern __gshared void* _tls_end;
+            extern __gshared void* __xl_a;
+
+            alias _tls_start _tlsstart;
+            alias _tls_end   _tlsend;
+            alias __xl_a     _tls_callbacks_a;		
+		}
+        else version (Win32)
         {
             extern __gshared void* _tlsstart;
             extern __gshared void* _tlsend;
diff --git a/libphobos/libdruntime/core/sys/windows/mingwasm.S b/libphobos/libdruntime/core/sys/windows/mingwasm.S
new file mode 100644
index 0000000..49b5918
--- /dev/null
+++ b/libphobos/libdruntime/core/sys/windows/mingwasm.S
@@ -0,0 +1,35 @@
+/**
+ * Support code for MinGW fibers.
+ */
+ 	.global	_fiber_switchContext
+_fiber_switchContext:
+	// Save current stack state.save current stack state
+	// Standard CDECL prologue.  
+	push %EBP;
+	mov  %ESP, %EBP;
+	push %EDI;
+    push %ESI;
+    push %EBX;
+    push %FS:0;
+    push %FS:4;
+    push %FS:8;
+    push %EAX;
+
+    // store oldp again with more accurate address
+    mov 8(%EBP), %EAX;
+    mov %ESP, (%EAX);
+    // load newp to begin context switch
+    mov 12(%EBP), %ESP;
+
+    // load saved state from new stack
+    pop %EAX;
+    pop %FS:8;
+    pop %FS:4;
+    pop %FS:0;
+    pop %EBX;
+    pop %ESI;
+    pop %EDI;
+    pop %EBP;
+
+    // 'return' to complete switch
+    ret;
diff --git a/libphobos/libdruntime/core/thread.d b/libphobos/libdruntime/core/thread.d
index 3d858af..2ec7a13 100644
--- a/libphobos/libdruntime/core/thread.d
+++ b/libphobos/libdruntime/core/thread.d
@@ -3069,6 +3069,21 @@ private
             version = AlignFiberStackTo16Byte;
         }
     }
+    else version( GNU_InlineAsm )
+    {
+        version( MinGW64 )
+        {
+            version = GNU_AsmX86_64_Windows;
+            version = AlignFiberStackTo16Byte;
+			version = AsmExternal;
+        }
+        else version( MinGW )
+        {
+            version = GNU_AsmX86_Windows;
+            version = AlignFiberStackTo16Byte;
+			version = AsmExternal;
+        } 
+    }	
     else version( PPC )
     {
         version( Posix )
@@ -3337,10 +3352,99 @@ private
                 jmp RCX;
             }
         }
-        else version(MinGW)
+        else version( GNU_AsmX86_Windows )
         {
-            assert(0, "unimplemented");
+			// This requires function prologue to be generated.
+			// However, gcc -O2 will avoid this making this unusable here.
+			static assert(false, "fiber_switchContext should be AsmExternal");
+            asm 
+            {   "
+                // save current stack state
+                // Standard prologue.  
+                //push %%EBP;
+                //mov  %%ESP, %%EBP;
+                push %%EDI;
+                push %%ESI;
+                push %%EBX;
+                push %%FS:0;
+                push %%FS:4;
+                push %%FS:8;
+                push %%EAX;
+
+                // store oldp again with more accurate address
+                mov 8(%%EBP), %%EAX;
+                mov %%ESP, (%%EAX);
+                // load newp to begin context switch
+                mov 12(%%EBP), %%ESP;
+
+                // load saved state from new stack
+                pop %%EAX;
+                pop %%FS:8;
+                pop %%FS:4;
+                pop %%FS:0;
+                pop %%EBX;
+                pop %%ESI;
+                pop %%EDI;
+                pop %%EBP;
+
+                // 'return' to complete switch
+                ret;
+                "
+                : /* outputs */
+                : /* inputs */
+                : /* clobbers */
+                ;
+            }
         }
+        else version( GNU_AsmX86_64_Windows )
+        {
+			// This requires function prologue to be generated.
+			// However, gcc -O2 will avoid this making this unusable
+			// This makes this block unusuable.
+			static assert(false, "fiber_switchContext should be AsmExternal");
+            asm 
+            {   "
+                // save current stack state
+                // Standard prologue
+                //pushq %%RBP;
+                //movq  %%RSP, %%RBP;
+                pushq %%RBX;
+                pushq %%R12;
+                pushq %%R13;
+                pushq %%R14;
+                pushq %%R15;
+                pushq %%GS:0;
+                pushq %%GS:8;
+                pushq %%GS:16;
+
+                // store oldp
+                movq %%RSP, (%%RCX);
+                // load newp to begin context switch
+                movq %%RDX, %%RSP;
+
+                // load saved state from new stack
+                popq %%GS:16;
+                popq %%GS:8;
+                popq %%GS:0;
+                popq %%R15;
+                popq %%R14;
+                popq %%R13;
+                popq %%R12;
+                popq %%RBX;
+                popq %%RBP;
+
+                // 'return' to complete switch
+                popq %%RCX;
+                jmp *%%RCX;
+                "
+                : /* outputs */
+                : /* inputs */
+                : /* clobbers */ 
+                ;
+            }
+
+//            assert(false, "x86-64 stub");
+        }	
         else static if( __traits( compiles, ucontext_t ) )
         {
             Fiber   cfib = Fiber.getThis();
@@ -4332,9 +4436,45 @@ private:
              */
             pstack += int.sizeof * 1;
         }
-        else version(MinGW)
+        else version( GNU_AsmX86_Windows )
         {
-            assert(0, "unimplemented");
+            version( StackGrowsDown ) {} else static assert( false );
+
+            // Currently, MinGW doesn't utilize SEH exceptions.
+            // See DMD AsmX86_Windows If this code ever becomes fails and SEH is used.
+
+            push( 0x00000000 );                                     // Return address of fiber_entryPoint call
+            push( cast(size_t) &fiber_entryPoint );                 // EIP
+            push( 0x00000000 );                                     // EBP
+            push( 0x00000000 );                                     // EDI
+            push( 0x00000000 );                                     // ESI
+            push( 0x00000000 );                                     // EBX
+            push( 0xFFFFFFFF );                                     // FS:[0] - Current SEH frame
+            push( cast(size_t) m_ctxt.bstack );                     // FS:[4] - Top of stack
+            push( cast(size_t) m_ctxt.bstack - m_size );            // FS:[8] - Bottom of stack
+            push( 0x00000000 );                                     // EAX
+        }
+        else version( GNU_AsmX86_64_Windows )
+        {
+            push( 0x00000000_00000000 );                            // Return address of fiber_entryPoint call
+            push( cast(size_t) &fiber_entryPoint );                 // RIP
+            push( 0x00000000_00000000 );                            // RBP
+            push( 0x00000000_00000000 );                            // RBX
+            push( 0x00000000_00000000 );                            // R12
+            push( 0x00000000_00000000 );                            // R13
+            push( 0x00000000_00000000 );                            // R14
+            push( 0x00000000_00000000 );                            // R15
+            push( 0xFFFFFFFF_FFFFFFFF );                            // GS:[0] - Current SEH frame
+            version( StackGrowsDown )
+            {
+                push( cast(size_t) m_ctxt.bstack );                 // GS:[8]  - Top of stack
+                push( cast(size_t) m_ctxt.bstack - m_size );        // GS:[16] - Bottom of stack
+            }
+            else
+            {
+                push( cast(size_t) m_ctxt.bstack );                 // GS:[8]  - Top of stack
+                push( cast(size_t) m_ctxt.bstack + m_size );        // GS:[16] - Bottom of stack
+            }
         }
         else static if( __traits( compiles, ucontext_t ) )
         {
-- 
1.8.5.2.msysgit.0

